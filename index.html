<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mural Bersama</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, sans-serif;
            background: #1a1a1a;
        }
        
        .top-bar {
            background: #2d2d2d;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #404040;
        }
        
        .room-info {
            background: #404040;
            padding: 6px 12px;
            border-radius: 20px;
            font-family: monospace;
            font-size: 14px;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
        }
        
        #canvas {
            display: block;
            width: 100vw;
            height: calc(100vh - 60px);
            background: white;
            cursor: crosshair;
            touch-action: none;
        }
        
        .toolbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d2d2d;
            padding: 10px;
            border-radius: 40px;
            display: flex;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .tool-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: #404040;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tool-btn.active {
            background: #4CAF50;
            transform: scale(1.1);
        }
        
        #colorPicker {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #fff;
            cursor: pointer;
            padding: 0;
        }
        
        .user-badge {
            background: #4CAF50;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div>üé® Mural Bersama</div>
        <div class="room-info" id="roomDisplay"></div>
        <button onclick="copyLink()">üìã Bagikan Link</button>
    </div>
    
    <canvas id="canvas"></canvas>
    
    <div class="toolbar">
        <button class="tool-btn active" id="toolDraw" onclick="setTool('draw')">‚úèÔ∏è</button>
        <button class="tool-btn" id="toolText" onclick="setTool('text')">üìù</button>
        <input type="color" id="colorPicker" value="#000000">
        <button class="tool-btn" onclick="clearCanvas()">üóëÔ∏è</button>
    </div>
    
    <div class="user-badge" id="userCount">üë• 1 online</div>

    <!-- Gunakan layanan pihak ketiga untuk real-time -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // ===== KONFIGURASI ROOM =====
        const urlParams = new URLSearchParams(window.location.search);
        const ROOM_ID = urlParams.get('room') || 'ruang-' + Math.random().toString(36).substring(2, 8);
        
        window.history.replaceState({}, '', '?room=' + ROOM_ID);
        document.getElementById('roomDisplay').textContent = 'üö™ ' + ROOM_ID;

        // ===== SETUP CANVAS =====
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight - 60;
        
        window.addEventListener('resize', () => {
            const oldData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 60;
            ctx.putImageData(oldData, 0, 0);
        });

        // ===== STATE =====
        let isDrawing = false;
        let lastX, lastY;
        let currentTool = 'draw';
        let currentColor = '#000000';

        // ===== GAMBAR =====
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let clientX, clientY;
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        // ===== REAL-TIME DENGAN SERVER PUBLIK =====
        // Gunakan server publik untuk relay data
        const socket = io('wss://websocket-relay.fly.dev', {
            transports: ['websocket']
        });
        
        socket.on('connect', () => {
            console.log('Terhubung ke server!');
            socket.emit('join-room', ROOM_ID);
            
            // Minta data yang sudah ada
            socket.emit('request-data', ROOM_ID);
        });
        
        // Terima data dari user lain
        socket.on('draw-data', (data) => {
            if (data.type === 'draw') {
                ctx.strokeStyle = data.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(data.x1, data.y1);
                ctx.lineTo(data.x2, data.y2);
                ctx.stroke();
            } else if (data.type === 'text') {
                ctx.font = '20px Arial';
                ctx.fillStyle = data.color;
                ctx.fillText(data.text, data.x, data.y);
            }
        });
        
        // Terima data history saat join
        socket.on('history-data', (history) => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            history.forEach(data => {
                if (data.type === 'draw') {
                    ctx.strokeStyle = data.color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(data.x1, data.y1);
                    ctx.lineTo(data.x2, data.y2);
                    ctx.stroke();
                } else if (data.type === 'text') {
                    ctx.font = '20px Arial';
                    ctx.fillStyle = data.color;
                    ctx.fillText(data.text, data.x, data.y);
                }
            });
        });
        
        // Update user count
        socket.on('user-count', (count) => {
            document.getElementById('userCount').textContent = `üë• ${count} online`;
        });

        // ===== EVENT LISTENERS =====
        canvas.addEventListener('mousedown', (e) => {
            if (currentTool === 'draw') {
                isDrawing = true;
                const pos = getMousePos(e);
                lastX = pos.x;
                lastY = pos.y;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = 2;
            }
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing || currentTool !== 'draw') return;
            
            const pos = getMousePos(e);
            
            // Gambar lokal
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            
            // Kirim ke server
            socket.emit('draw', {
                room: ROOM_ID,
                type: 'draw',
                x1: lastX,
                y1: lastY,
                x2: pos.x,
                y2: pos.y,
                color: currentColor
            });
            
            lastX = pos.x;
            lastY = pos.y;
        });
        
        canvas.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('mouseout', () => isDrawing = false);
        
        canvas.addEventListener('click', (e) => {
            if (currentTool !== 'text') return;
            
            const pos = getMousePos(e);
            const text = prompt('Tulis pesan:', '');
            
            if (text) {
                // Gambar lokal
                ctx.font = '20px Arial';
                ctx.fillStyle = currentColor;
                ctx.fillText(text, pos.x, pos.y);
                
                // Kirim ke server
                socket.emit('draw', {
                    room: ROOM_ID,
                    type: 'text',
                    x: pos.x,
                    y: pos.y,
                    text: text,
                    color: currentColor
                });
            }
        });

        // ===== TOOLBAR =====
        window.setTool = function(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tool === 'draw' ? 'toolDraw' : 'toolText').classList.add('active');
            canvas.style.cursor = tool === 'draw' ? 'crosshair' : 'text';
        };
        
        document.getElementById('colorPicker').addEventListener('input', (e) => {
            currentColor = e.target.value;
        });
        
        window.clearCanvas = function() {
            if (confirm('Hapus semua?')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                socket.emit('clear-room', ROOM_ID);
            }
        };
        
        socket.on('room-cleared', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
        
        window.copyLink = function() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('‚úÖ Link disalin! Buka di device lain untuk test real-time');
            });
        };

        console.log('Share link:', window.location.href);
    </script>
</body>
</html>
